name: secrets-scan

on:
  pull_request:
  push:
    branches: ["**"]

jobs:
  secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Установить зависимости (jq)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Запустить docker-compose (локальный оркестратор)
        run: |
          docker compose -f docker-compose.yml up -d --build
        env:
          QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}

      - name: Установка gitleaks
        run: |
          GITLEAKS_VERSION=8.18.2
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz \
          | tar -xz gitleaks
          sudo mv gitleaks /usr/local/bin/gitleaks

      - name: Запустить сканер и отправить отчёт
        run: |
          bash scripts/ci/secrets_scan.sh
        env:
          ORCH_URL: http://localhost:8000
          SCANNER: gitleaks
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}

      - name: Сохранить артефакты
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secrets-artifacts
          path: |
            gitleaks.sarif
            analyze.json
            status.json
